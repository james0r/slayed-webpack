<script type="application/json" data-ajax-cart-initial-state>
  {{ cart | json }}
</script>

<script type="module">
  import { subscribeToCartAjaxRequests, subscribeToCartStateUpdate } from '{{ 'liquid-ajax-cart-v1.6.0.static.js' | asset_url }}';

  subscribeToCartAjaxRequests((requestState, subscribeToResult) => {

    if (requestState.requestType === 'add') {

      subscribeToResult(requestState => {
        if (requestState.responseData?.ok) {
            // document.body.querySelector('.minicart').classList.add('animate-red')

            Alpine.store('globals').minicartIsShowing = true
        }
      })
    }

    if (requestState.requestType === "change") {

      // Recall the item key and the quantity that we want to set
      let itemKey, requestedQuantity;

      if (requestState.requestBody instanceof FormData) {
        itemKey = requestState.requestBody.get('id');
        requestedQuantity = requestState.requestBody.get('quantity');
      } else {
        itemKey = requestState.requestBody.id;
        requestedQuantity = requestState.requestBody.quantity;
      }

      // Only notify of errors for non-remove requests
      if (requestedQuantity > 0) {
        document.querySelector(`[data-item-key="${itemKey}"] .loading-indicator`).style.display = 'inline-block'
        document.querySelector(`[data-item-key="${itemKey}"] .loading-indicator`).setAttribute('aria-busy', true)
        document.querySelector(`[data-ajax-cart-quantity-input="${itemKey}"]`).style.display = 'none'
  
        subscribeToResult(requestState => {
          if (requestState.responseData?.ok) {
  
            document.querySelector(`[data-item-key="${itemKey}"] .loading-indicator`).style.display = 'none'
            document.querySelector(`[data-item-key="${itemKey}"] .loading-indicator`).setAttribute('aria-busy', false)
            document.querySelector(`[data-ajax-cart-quantity-input="${itemKey}"]`).style.display = 'inline-block'
  
            // Find the item in the Shopify response
            const itemData = requestState.responseData.body.items.find(element => element.key === itemKey);
            if (itemData) {
              const newQuantity = itemData.quantity;
              if (newQuantity < requestedQuantity) {
                document.querySelector(`[data-ajax-cart-form-error="${itemKey}"]`).innerHTML = 'The requested quantity exceeds the quantity available.'
  
              }
            }
          }
        });
      }
    }
  });
</script>